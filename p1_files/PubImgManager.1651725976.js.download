dynamicallyLoadScript("/js/smartcrop.min.js");class ImgUI{constructor(){this.file=null,this.fileName=null,this.img=null,this.ino=null,this.orderWeight=null,this.fileId=null,this.type=null,this.imageType=null,this.status=null,this.objectUrl=null,this.iUrl=null,this.tUrl=null,this.iBlobUrl=null,this.tBlobUrl=null,this.iBlob=null,this.tBlob=null,this.bytesLoaded=0,this.bytesTotal=0,this.width,this.height}}PubImgManager=function(e,t,i,n,a,s,l){const o=1024;var r=[],d=null;this.init=function(){const e=$("#"+t);e.html(`\n\t\t\t<div class="panel panel-success">\n\t\t\t\t<div class="panel-heading">\n               <input type='file' id='fileElem' multiple accept='image/*' style='display: none'>\n               <span id='fileSelect' class='btn btn-default'>\n               <i class="fa fa-plus"></i><i class="fa fa-image"></i>\n               ${roliaMsg.pub_img_manager.add_images}</span>\n\n               <i class="click fa fa-question-circle-o ml10" \n                  onclick="$(this).closest('.panel').find('.panel-footer').show();$(this).hide()"></i>\n               <div id='trash' class='fa fa-trash fa-2x' style='height: 48px; width: 48px; overflow: hidden; float:right'></div>\n            </div>\n\t\t\t\t<div class="panel-body" id='imageListContainer'>\n               <ul id='imageList' style='padding-inline-start: 0;'></ul>\n\t\t\t\t</div>\n\t\t\t\t<div class="panel-footer" style="display:none">\n               ${roliaMsg.pub_img_manager.user_image_note}\n\t\t\t\t</div>\n\n\t\t\t</div>\n\t\t`),d=e.find("#imageList")[0];const i=e.find("#fileElem")[0];e.find("#fileSelect").on("click",null,(function(e){return e.preventDefault(),i.click(),!1})),i.addEventListener("change",g,!1);const n=e.find("#trash")[0];n.addEventListener("click",(()=>toastr.info(roliaMsg.pub_img_manager.trash_note)),!1),Sortable.create(n,{group:"imageList",ghostClass:"trash-sortable-ghost",onAdd:function(e){var t=e.item.id;w(t);var i=document.getElementById(t);$(i).fadeOut(500,(function(){i.parentNode.removeChild(i)}))}})},this.setImgUiArr=function(e){if(r=e,d.innerHTML="",0!=r.length){for(let e=0;e<r.length;e++){const t=r[e];t.fileName=`${t.fileId}.jpg`;const i=document.createElement("img");i.height=96,i.width=96,t.img=i;const n=document.createElement("li");d.appendChild(n),n.id=t.fileName,n.appendChild(i),i.src=t.tUrl,i.classList.add("uploaded")}h(),m()}};var c=function(e){var t=";base64,";if(-1==e.indexOf(t)){var i=(a=e.split(","))[0].split(":")[1],n=a[1];return new Blob([n],{type:i})}i=(a=e.split(t))[0].split(":")[1];for(var a,s=(n=window.atob(a[1])).length,l=new Uint8Array(s),o=0;o<s;++o)l[o]=n.charCodeAt(o);return new Blob([l],{type:i})};handle_Files=()=>{};var g=function(){fileAlreadySelected=function(e){const t=sanitizeFileName(e.name);var i=!1;return r.forEach((e=>{e.fileName==t&&(i=!0,toastr.warning(roliaMsg.pub_img_manager.duplicated_img))})),i},r||(r=[]),currImgUiArr=[];const t=new CircularProgressBar("f03e",l);var i=[];funcOnUploadSuccess=(e,t)=>{e.status="UPLOADED",imgUiNew=JSON.parse(t),U(e,imgUiNew)},funcOnUploadProgress=()=>{let e=0,n=0;i.forEach(((t,i)=>{e+=t.bytesTotal,n+=t.bytesLoaded}));let a=parseInt(100*n/e);t.setValue(a),100==a&&t.done()},funcOnUploadError=e=>{const n=e.img;n.classList.remove("uploading"),n.classList.add("error"),$(n).parent("li").fadeOut(2e3,(()=>{$(this).remove()})),L(i,e),L(r,e),0==i.length&&t.error(),toastr.error("Images were not uploaded","Network error",{closeButton:!0,debug:!1,newestOnTop:!1,progressBar:!1,positionClass:"toast-top-center",preventDuplicates:!0,onclick:null,showDuration:"0",hideDuration:"0",timeOut:"0",extendedTimeOut:"0",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"hide"})};const n=this.files.length,a=r.length,s=e-a;if(a>=e)toastr.error(sprintf(roliaMsg.pub_img_manager.max_img_note,e,a));else if(n>s)toastr.error(sprintf(roliaMsg.pub_img_manager.img_limit_note,e,s));else{for(let e=0;e<this.files.length;e++)this.files[e].name=this.files[e].name.replace(/[ ]/g,"_").replace(/['"\\/~`!@#$%^&*(){}\[\]|;:<>?,]/g,"");for(let e=0;e<this.files.length;e++){if(fileAlreadySelected(this.files[e]))continue;const t=new ImgUI;t.status="LOCAL",t.file=this.files[e],t.fileName=sanitizeFileName(t.file.name);const n=document.createElement("img");n.height=96,n.width=96,t.img=n;const a=document.createElement("li");d.appendChild(a),a.id=t.fileName,a.appendChild(n),r.push(t),i.push(t),u(t)}h(),m()}};set_Index=()=>{};var h=()=>($("#imageListContainer>ul>li").each(((e,t)=>$(t).attr("idx",e))),r.forEach((e=>e.orderWeight=e.img.parentNode.getAttribute("idx"))),r.sort(((e,t)=>parseInt(e.orderWeight)-parseInt(t.orderWeight))),!1);enable_Sortable=()=>{};var m=()=>(Sortable.create(document.getElementById("imageList"),{group:{name:"imageList"},onUpdate:function(){h(),s(r)},setData:function(e,t){e.setData("Text",t.id)}}),!1);step1_DisplaySrcImg=()=>{};var u=function(e){const t=e.img;t.src=URL.createObjectURL(e.file),t.classList.add("local"),t.onload=function(){URL.revokeObjectURL(this.src),f(e)}};step2_ResizeImage=()=>{};var f=function(e){const t=e.file;e.status="RESIZING";var n=new FileReader;n.onload=function(t){var a=new Image;a.onload=function(t){const s=a.width/a.height>2.5&&a.height>o;var l,r=null;if(s)l=n.result,r=c(l),e.imageType=s?"PANO":"",e.width=a.width,e.height=a.height,i(e);else{var d=document.createElement("canvas");l=(d=function(e,t,n){var a,s,l=e.width,r=e.height;const d=l/r>2.5&&r>o;var c=t.getContext("2d");return c.mozImageSmoothingEnabled=!0,c.webkitImageSmoothingEnabled=!0,c.msImageSmoothingEnabled=!0,c.imageSmoothingEnabled=!0,d?r>o?(s=o,a=parseInt(l*s/r)):(s=r,a=l):l>o?(a=o,s=parseInt(r*o/l)):(a=l,s=r),n.imageType=d?"PANO":"",n.width=a,n.height=s,i(n),t.width=a,t.height=s,c.drawImage(e,0,0,a,s),t}(a,d,e)).toDataURL("image/jpeg"),r=c(l)}e.status="LOCAL",e.iBlobUrl=l,e.iBlob=r,p(a,e)},a.src=t.target.result},n.readAsDataURL(t)},p=(e,t)=>{const i=m/u>2.5&&u>o,n=96,a=document.createElement("canvas");a.width=n,a.height=n;var s=a.getContext("2d");s.mozImageSmoothingEnabled=!0,s.webkitImageSmoothingEnabled=!0,s.msImageSmoothingEnabled=!0,s.imageSmoothingEnabled=!0;var l,r,d,g,h,m=e.width,u=e.height,f=Math.min(m,u),p=(d=f,g=n,h=Math.floor(Math.log(d/g)/Math.log(2)),g*Math.pow(2,h)),b={width:n,height:n,minScale:.5,ruleOfThirds:!0};(async()=>{await smartcrop.crop(e,b).then((function(e){const t=e.topCrop;l=t.x,r=t.y,p=t.width}))})().then((()=>{s.drawImage(e,l,r,p,p,0,0,n,n),i&&(s.font="bold 24px sans-serif",s.strokeStyle="#FFFFFF",s.strokeText("PANO",15,24));const o=a.toDataURL("image/png"),d=c(o);t.tBlobUrl=o,t.tBlob=d,v(t)}))};step3_DisplayThumbnail=()=>{};var v=function(e){const t=e.img;t.src=e.tBlobUrl,t.classList.remove("local"),t.classList.add("resizing"),t.onload=function(){URL.revokeObjectURL(this.src),t.classList.remove("resizing"),t.classList.add("resized"),b(e)}};step4_UploadImg=()=>{};var b=function(e){e.status="UPLOADING";const t=e.img;t.classList.remove("resized"),t.classList.add("uploading"),n(e,funcOnUploadSuccess,funcOnUploadProgress,funcOnUploadError)};update_ImgUi_From_Server=()=>{};var U=function(e,t){e.fileId=t.fileId,e.ino=t.ino,e.status=t.status,e.iUrl=t.iUrl,e.tUrl=t.tUrl;const i=e.img;i.classList.remove("uploading"),i.classList.add("uploaded")};remove_ImgUi_By_File_Name=()=>{};var w=e=>{const t=r.find((t=>t.fileName==e));a(t),L(r,t)};remove_imgUi_from_array=()=>{};var L=(e,t)=>{e.splice(e.findIndex((e=>e.fileName==t.fileName)),1)};this.init()};