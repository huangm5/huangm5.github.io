var postEditor,stepScr;AutoSaver=function(t){var e,n="ped",i=function(){var e=new PostEditorData;e.ckeData=t.getData(),e.title=$("#title").val(),e.urllink=$("#urllink").val();let i=JSON.stringify(e);localStorage.setItem(n,i)};this.start=function(){let n=this.getSavedData();null!=n&&(t.setData(n.ckeData),$("#title").val(n.title),$("#urllink").val(n.urllink),$("#title").trigger("input")),e=setInterval(i,2e3)},this.stop=function(){window.clearInterval(e)},this.reset=function(){localStorage.removeItem(n)},this.getSavedData=function(){var t=localStorage.getItem(n);return ped=null!=t?JSON.parse(t):null,ped}};class PostEditorData{constructor(){this.title=null,this.ckeData=null,this.urllink=null}}class EditPostSession{constructor(){this.op="NEW",this.sessionKey=null,this.fno=fno,this.cno=null,this.parent=null,this.pno=null,this.title="",this.contents="",this.urllink="",this.audioSno=null,this.audioStatus=null,this.audioUi=null,this.imgStatus=null,this.imgUiArr=[],this.ckEditor=null,this.ckEditorImgStatus=null,this.anonymous=!1}reset(){this.op=null,this.sessionKey=null,this.fno=fno,this.cno=null,this.parent=null,this.pno=null,this.title="",this.contents="",this.urllink="",this.audioSno=null,this.imgStatus=null,this.imgUiArr=[],this.ckEditorImgStatus=null,this.anonymous=!1}setPost(t){this.fno=t.fno,this.pno=t.pno,this.title=t.title,this.contents=t.contents,this.urllink=t.urllink,this.anonymous=t.isAnonymous,$("#title").val(t.title),$("#urllink").val(t.urllink),$("#anonymous").prop("checked",this.anonymous),this.ckEditor.setData(t.contents?t.contents:"")}}PostEditor=function(){var t=!0;const e=$("#edit-post-container");var n,i,o,a,s,r,l=new EditPostSession;this.getSession=()=>l,this.init=function(){A().then((()=>{r=new AutoSaver(a)})),stepScr=new StepScr($("#edit-post-container"),d,(()=>{}),"/",t),(n=new PubImgManager(16,"postImages",w,b,_,k,$("#div-uploading .image"))).setImgUiArr(l.imgUiArr),i=new AudioManager("div-post-audio",m,f,g,h,$("#div-uploading .audio")),o=$("#f1").validate({rules:{urllink:{url:!0}}}),$(".nav-button.submit").attr("tabindex",2),$.validator.addMethod("maxBySize",(function(t,e,n){var i=t.match(/[\u0000-\u007f]/g),o=i?i.length:0,a=encodeURI(t.replace(/[\u0000-\u007f]/g)).match(/%/g);return o+2*(a?a.length:0)/3<=n}),jQuery.validator.format(roliaMsg.mall.too_long_note)),D(),T()},reset_=()=>{};validateSubmit_=t=>0;validateNextBtn_=t=>0;var d=function(t){var e=!0;switch(t.attr("id")){case"scr-title":e=o.element("#title");break;case"scr-urllink":e=o.element("#urllink")}return e};_reloadUrl=t=>0;var c=()=>{alert("You signed out from Rolia in another browser window."),window.location.reload()};_createSessionKey=t=>0;var u=()=>{l.sessionKey||(request=$.ajax({url:"/api/v1/sessionKey",type:"GET"}),request.done((function(t,e,n){l.sessionKey=t})),request.fail((function(t,e,n){t.complete().responseText,t.complete().status;l.sessionKey=null,"SIGN_IN_NEEDED"==n&&c()})))};_OP=t=>0,this.newTopic=()=>{const t=_cno;r.start(),p(),$("#modal-post-editor").modal(),u(),$(".to-intro").show(),$(".to-audio").show(),$(".to-image").show(),stepScr.apply("intro, audio, image, title, contents, urllink, forum, ctg"),l.op="NEW",l.fno=fno;let n=e.find(`input[name='fno'][value='${fno}']`);n.prop("checked",!0);let i=n.find("+label").html();$("#pe-forum-selected").html(i),$("#pe-forum-options").hide(),$("#pe-btn-change-forum").show(),E(fno),l.cno=t,e.find(`input[id='f${fno}-c${t}']`).prop("checked",!0);let o="title";[6300,2100,2320,3100,3250,7050].includes(_cno)&&(o="image"),6400==_cno&&(o="audio"),stepScr.goToScr(o),v(),P(),T()},this.reply=t=>{p(),$("#modal-post-editor").modal();const n=$(`form#reply${t} textarea`),i=e.find("textarea#title");var o=i.val(),a=n.val();a&&!o&&(i.val(a),n.val(""),setTimeout((function(){Service.textareaAdjustFlexHeight(i.get(0)),Service.textareaAdjustFlexHeight(n.get(0))}),123),l.title=a);const s=$(`form#reply${t} input[name='anonymous']`),r=e.find("input[name='anonymous']");if(1==s.length&&1==r.length){const t=s.prop("checked");r.prop("checked",t),l.anonymous=t}u(),l.op="REPLY",l.fno=fno,l.parent=t,$(".to-intro").show(),$(".to-audio").show(),$(".to-image").show(),stepScr.apply("intro, audio, image, title, contents, urllink"),stepScr.goToScr("title"),v(),P(),T()},this.modify=(t,e,n=!1)=>{var i=new FormData;i.append("fno",t),i.append("pno",e),postDataAsForm(`/api/f/${n?"admPostToModify":"postToModify"}`,i).then((t=>{const e=JSON.parse(t);l.setPost(e),l.op=n?"ADM_MODIFY":"MODIFY",p(),$("#modal-post-editor").modal(),$(".to-intro").hide(),$(".to-audio").hide(),$(".to-image").show(),stepScr.apply("image, title, contents, urllink"),stepScr.goToScr("title"),n||v(),P(),T()}),(t=>{}))};var p=()=>{$(".adsbygoogle").css("z-index",1)};_AUDIO=t=>0,get_UnusedAudio=t=>0;var m=function(t){postDataAsForm("/api/asset/findUnusedAudio").then((e=>{const n=t(e);null==n||n.sno<1||(l.audioUi=n,l.audioStatus="UPLOADED")}))},h=t=>{l.audioSno=t};use_AudioSno=t=>0,upload_Audio=()=>{};var f=function(t,e,n,i){l.audioStatus="UPLOADING",T();var o=new FormData;o.append("userAudio",t.file),uploadWithProgress("/api/asset/uploadAudio",o,(t=>{l.audioUi=JSON.parse(t),l.audioSno=l.audioUi.sno,l.audioStatus="UPLOADED",e(t),T()}),((t,e)=>{l.audioUi=null,l.audioSno=null,l.audioStatus="ERROR",console.log("in epFuncError",t,e),i(t,e),T()}),n)},g=function(t,e){var n=new FormData;n.append("sno",t.sno),postDataAsForm("/api/asset/deleteAudio",n).then(e)};_IMAGE=t=>0;var v=function(){postDataAsForm("/api/asset/findUnusedImg").then((t=>{let e=JSON.parse(t);0!=e.length&&(e.forEach((t=>{t.iUrl=`/uiV2/${t.fileId}.jpg`,t.tUrl=`/uiV2/${t.fileId}_t.png`,t.width="auto",t.height="auto"})),l.imgUiArr=e,n.setImgUiArr(l.imgUiArr),"loaded"==CKEDITOR.status?l.imgUiArr.forEach((t=>{w(t),I(t)})):CKEDITOR.on("instanceReady",(function(t){"APPLIED"!=l.ckEditorImgStatus&&(l.imgUiArr.forEach((t=>{w(t),I(t)})),l.ckEditorImgStatus="APPLIED")})),stepScr.goToScr("image"))}),(t=>{"SIGN_IN_NEEDED"==t.statusText&&c()}))};setImgStatus_=()=>{};var S=()=>{l.imgStatus="VOID",l.imgUiArr.forEach((t=>{"UPLOADING"==t.status&&(l.imgStatus="UPLOADING")}))};addImageToEditor_=()=>{};var w=t=>{CKEDITOR.instances.contents.setMode("wysiwyg",(()=>{})),s=e.find("iframe.cke_wysiwyg_frame").get(0).contentWindow.document.body;const n=t.ino,i=t.fileName;let o="";const a=t.imageType.toLowerCase();$(s).find(`img[data-ino=${n}]`).length>0||(o=`\n\t\t\t<div class='user-image-holder pending' data-file-name='${i}'>\n\t\t\t\t<p>: </p>\n\t\t\t\t<p><img class='user-image pending ${a}' data-ino='' data-file-name='${i}' src='' \n\t\t\t\t\t\tdata-type='${t.imageType}'\n\t\t\t\t\t\twidth='${t.width}' height='${t.height}' alt='${i} will show here after it is uploaded.' /></p>\n\t\t\t</div>\n\t\t`,$(s).append(o))};delete_ImageFromEditor=()=>{};var y=t=>{CKEDITOR.instances.contents.setMode("wysiwyg",(()=>{})),s=e.find("iframe.cke_wysiwyg_frame").get(0).contentWindow.document.body;const n=t.fileName;$(s).find(`div.user-image-holder.pending[data-file-name='${n}']`).remove()};uploadImage_=()=>{};var b=function(t,e,n,i){l.imgStatus="UPLOADING",T();var o=new FormData;o.append("imageToUpload",t.iBlob),o.append("thumbnail",t.tBlob),o.append("orderWeight",t.orderWeight),o.append("width",t.width),o.append("height",t.height),o.append("imageType",t.imageType),uploadWithProgress("/api/asset/uploadImg",o,(n=>{e(t,n),S(),T(),I(t)}),((e,n)=>{i(t),y(t),S(),T()}),(e=>{var i=e.position||e.loaded,o=e.totalSize||e.total;t.bytesLoaded=i,t.bytesTotal=o,n()}))};delete_Image=()=>{};var _=t=>{var e=new FormData;e.append("ino",t.ino),postDataAsForm("/api/asset/deleteImg",e).then((e=>{y(t)}))};reorder_ImagesInEditor=t=>0;var k=function(t){CKEDITOR.instances.contents.setMode("wysiwyg",(()=>{})),s=e.find("iframe.cke_wysiwyg_frame").get(0).contentWindow.document.body;let n=null,i=null;t.map((t=>t.fileName)).forEach(((t,e)=>{i=$(s).find(`div.user-image-holder.pending[data-file-name='${t}']`),null!=n&&i.insertAfter(n),n=i}))};update_ImageInEditor=()=>{};var I=t=>{CKEDITOR.instances.contents.setMode("wysiwyg",(()=>{})),s=e.find("iframe.cke_wysiwyg_frame").get(0).contentWindow.document.body;const n=t.fileName,i=t.ino;if("PANO"==t.imageType){let e=$(s).find(`img.pending[data-file-name='${n}']`);e.attr("src",t.iUrl),e.attr("data-ino",i),e.removeAttr("alt")}else{let e=$(s).find(`img.pending[data-file-name='${n}']`);e.attr("src",t.iUrl),e.attr("data-ino",i),e.removeAttr("alt")}};register_EventListeners=()=>{};var D=()=>{e.on("click",".submit",(function(t){t.preventDefault(),N()})),e.on("activated revisited","#scr-contents",(function(t){a.focus()})),e.on("activated revisited",".step-scr:has(textarea)",(function(t){$(this).find("textarea").focus()})),e.on("activated",".step-scr.radio-input",(function(t){$(this).find("input:radio:checked").length>0?$(this).find("button.next").removeAttr("disabled"):$(this).find("button.next").attr("disabled","disabled")})),e.on("input change","textarea.sync",(function(t){let e=$(this).attr("id"),n=$(this).val().trim();l[e]=n,T()})),e.on("change","input:checkbox",(function(t){let e=$(this).prop("name"),n=$(this).prop("checked");return l[e]=n,!1})),e.on("change","input:radio",(function(t){var e=$(this).closest("div.step-scr");let n=e.data("field"),i=$(this).data("brief"),o=$(this).val();l[n]=o,e.find("button.next").removeAttr("disabled"),toastr.remove(),i&&i.length>0&&toastr.info(i),T()})),e.on("change","input:radio[name='fno']",(function(t){let e=$(this).val(),n=$(this).data("brief"),i=$(this).find("+label").html();$("#pe-forum-selected").html(i),toastr.remove(),n.length>0&&toastr.info(n),E(e)})),e.on("click","#pe-btn-change-forum",(function(t){$("#pe-forum-options").show(),$("#pe-btn-change-forum").hide()}))};funcOnSetFno_=t=>0;var E=t=>{let n=$("#scr-forum"),i=$("#scr-ctg");l.cno=null,e.find("input[name='cno']").prop("checked",!1),i.addClass("active"),l.fno=t,n.find("button.next").removeAttr("disabled"),e.find("span.opt-cno").hide()&&e.find(`span.opt-cno.f${t}`).show(),0==e.find('span.opt-cno:not([style*="display: none"])').length?(n.find("button.next").hide(),i.removeClass("active")):(n.find("button.next").show(),i.addClass("active")),T()};init_CKEditor=()=>{};var A=async function(){$taContents=e.find("textarea#contents");var t=$taContents.val();$taContents.val(nl2br(t));var n="body {font-size: "+$("body").css("font-size")+"; font-family: "+$("body").css("font-family")+";} ";n+=" img{max-width:100%;height:auto;} ",a=CKEDITOR.replace("contents",{contentsCss:n,tabIndex:3,customConfig:"/script/ckeditor_config.js?v=1"}),l.ckEditor=a;var i="#ckeMax";a.on("maximize",(function(){1==e.find(".cke_maximized").length?(Service.ckeMax=!0,window.history.pushState("ckeMax",null,i)):(Service.ckeMax=!1,location.hash==i&&(Service.historyBackOnly=!0,window.history.back()))}))},P=()=>{const t=e.find(".span-anonymous");t.hide(),(isAnonymousAllowed||"MODIFY"==l.op&&l.anonymous)&&t.show()};setSubmitButtonStatus_=()=>{};var T=()=>{const t=l.fno;if("UPLOADING"==l.audioStatus||"UPLOADING"==l.imgStatus){const t="<i class='fa fa-spin fa-spinner'></i>";stepScr.disableSubmit(t+roliaMsg.step_scr.uploading),disableQuickSubmit(t+roliaMsg.step_scr.uploading)}else 0==l.title.length?(stepScr.disableSubmit(roliaMsg.pls_enter_title),disableQuickSubmit(roliaMsg.pls_enter_title)):"NEW"==l.op&&O(t)&&l.cno<1?(stepScr.disableSubmit(roliaMsg.pls_choose_ctg),disableQuickSubmit(roliaMsg.pls_choose_ctg)):(stepScr.enableSubmit(),enableQuickSubmit())};enableQuickSubmit=()=>{const t=e.find("button.quick-submit");t.html("<i class='fa fa-send-o mr5'></i>"+roliaMsg.step_scr.submit),t.prop("disabled",!1)},disableQuickSubmit=t=>{const n=e.find("button.quick-submit");n.html(t),n.prop("disabled",!0)},hasCtg_=()=>{};var O=t=>e.find(`span.opt-cno.f${t}`).length>0;_SUBMIT=()=>0,do_Submit=()=>{};var N=()=>{if((()=>{let t="urllink",e=!0;return"NEW"==l.op&&O(l.fno)&&l.cno<1&&(t="ctg",toastr.error("Please select a category"),e=!1),o.element("#urllink")||(t="urllink",toastr.error("The URL format is incorrect."),e=!1),0==l.title.length&&(t="title",toastr.error("Please enter the title"),e=!1),e||stepScr.goToScr(t),e})()){var t,s;switch(r.stop(),l.audioSno>0&&(l.audioStatus="POSTING"),x(),l.op){case"NEW":t="newTopic",s=U;break;case"REPLY":t="reply",s=M;break;case"MODIFY":t="modify",s=M;break;case"ADM_MODIFY":t="admModify",s=M}var d=new FormData;d.append("sessionKey",l.sessionKey),d.append("title",l.title),d.append("contents",l.contents),d.append("urllink",l.urllink),d.append("fno",l.fno),d.append("cno",l.cno),d.append("audioSno",l.audioSno),d.append("parent",l.parent),d.append("pno",l.pno),d.append("anonymous",l.anonymous),$("#modal-post-editor").modal("hide"),showWaiting("Submitting post..."),postDataAsForm(`/api/f/${t}`,d).then((t=>{"POSTING"==l.audioStatus&&(l.audioUi=null)&&(l.audioStatus=null),s(t),n.init(),i.init(),l.reset(),e.find("input[name='fno']").prop("checked",!1),e.find("input[name='cno']").prop("checked",!1),e.find("textarea").val(""),a.setData(""),doneWaiting()}),(t=>{doneWaiting(),$("#modal-post-editor").modal("show")}))}};setSessionContents_=t=>0;var x=()=>{CKEDITOR.instances.contents.setMode("wysiwyg",(()=>{})),s=e.find("iframe.cke_wysiwyg_frame").get(0).contentWindow.document.body;let t=$(s).clone(),n=!1;if(t.find("img,iframe").length>0&&(n=!0),n)t.find("img.user-image.pending").removeClass("pending").removeAttr("data-file-name"),t.find("div.user-image-holder.pending").removeClass("pending").removeAttr("data-file-name"),l.contents=t.html();else{t.find("p").each(((t,e)=>{let n=$(e).html().replace(/&nbsp;/gi," ").trim();0==n.length||"<br>"==n?$(e).remove():$(e).html(n)}));let e=t.get(0).textContent||t.get(0).innerText||"",n=t.find("a,blockquote,div,em,li,ol,pre,s,strong,sub,sup,u,ul,h1,h2,h3,h4,table").length>0,i=t.find("p").length>1;l.contents=n||i?t.html():e}};_CALLBACK=t=>0,refreshTopicList_=t=>0;var U=function(t){r&&r.reset();var e=JSON.parse(t);sessionStorage.opStatusStr=t;let n=e.fno;var i=isPanelView?"v=p&":"",o=0==n?sprintf("/f/list.php?{1}uo=1&f={0}",n,i):sprintf("/f/list.php?{1}f={0}",n,i);window.location=o};refreshTopic_=t=>0;var M=function(t){r&&r.reset();var e=JSON.parse(t),n=e.fno,i=e.pno,o=e.tno,a=e.parent,s=e.op,l=e.msg,d=window.location.pathname;window.location.search;if(d.endsWith("advancedSearch.php")){$("#reply"+a+" textarea").val("");var c=sprintf("topic.php?f={0}&p={1}",n,i);if(_isIphone)window.location=c;else if(_isIOS){window.open(c,"_blank").focus()}else{window.open(c,"rolia_topic").focus()}}else if(d.endsWith("post.php")){$("#reply"+a+" textarea").val("");const t=window.opener;if(t)return t.focus(),(t.location.pathname.endsWith("topic.php")||t.location.pathname.endsWith("f/list.php"))&&t.loadTopic(n,o,i),"REPLY"==s&&t.toastr.success("Reply added."),"APPEND_TO_PARENT"==s&&t.toastr_warning(l),"APPEND_TO_SIBLING"==s&&t.toastr_warning(l),void window.close();c=sprintf("topic.php?f={0}&p={1}",n,i);_isIphone?window.location=c:window.open(c,"rolia_topic").focus()}else loadTopic(n,o,i),$(".pageDown").show();"MODIFY"==s&&toastr.success("Post modified."),"REPLY"==s&&toastr.success("Reply added."),"APPEND_TO_PARENT"==s&&toastr_warning(l),"APPEND_TO_SIBLING"==s&&toastr_warning(l)};this.init()},$(document).ready((function(){postEditor=new PostEditor}));