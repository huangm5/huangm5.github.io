var blogEditor;class EditBlogSession{constructor(){this.ckEditor=null,this.op="ADD",this.fno=0,this.ano=0,this.sno=0,this.seriesName="",this.penName="",this.brief="",this.status="",this.pno=0,this.title="",this.contents="",this.urllink="",this.styleNo=0}reset(){this.op=null,this.fno=0,this.ano=0,this.sno=0,this.seriesName="",this.penName="",this.brief="",this.status="",this.pno=0,this.title="",this.contents="",this.urllink="",this.styleNo=0}setArticle(t,e){this.ano=e.ano,this.brief=e.brief,this.sno=e.sno,t.find("textarea[name='brief']").val(this.brief),t.find(`input:radio[name='sno'][value='${this.sno}']`).prop("checked",!0),999999==this.sno?$(".divNewSeriesName").show():$(".divNewSeriesName").hide()}setPost(t,e){this.fno=e.fno,this.pno=e.pno,this.title=e.title,this.contents=e.contents,this.urllink=e.urllink,t.find("textarea[name='title']").val(e.title),t.find("textarea[name='urllink']").val(e.urllink),this.ckEditor.setData(e.contents?e.contents:""),"MODIFY"==this.op&&(this.styleNo=63&e.status,t.find(`input:radio[name='styleNo'][value='${this.styleNo}']`).prop("checked",!0))}}BlogEditor=function(){var t;const e=$("#edit-blog-container");var n,o,i,a,s,l=new EditBlogSession,r=async()=>{const t=await fetch("/api/blog/getHost").catch((t=>{throw t}));return o=await t.json(),l.styleNo=o.styleNo,e.find(`input:radio[name='styleNo'][value='${l.styleNo}']`).prop("checked",!0),o},d=()=>o&&!o.isNew,c=async()=>{const t=await fetch("/api/blog/getSeriesArr").catch((t=>{throw t}));return n=await t.json(),p(),n},p=()=>{var t="<div class=radio-pill>";t+=`<label><input type=radio name=sno value=0 ><u>${roliaMsg.blog.not_in_series}</u></label>`,n.forEach((e=>{const n=e.sno,o=e.name;t+=`<label><input type=radio name=sno value=${n} ><u>${o}</u></label>`})),t+=`<label><input type=radio name=sno value=999999 ><u>${roliaMsg.blog.a_new_series}</u></label>`,t+="</div>",e.find("div.series-options").html(t)};this.getSession=()=>l,this.init=function(){u(),r().then((()=>{v()})).then((()=>{t=new StepScr($("#edit-blog-container"),g,(()=>{}),"/",false),i=$("#fBlog").validate({rules:{penName:{required:!0},urllink:{url:!0}}}),$.validator.addMethod("minBySize",minBySize,jQuery.validator.format(roliaMsg.v.min_by_size)),$.validator.addMethod("maxBySize",maxBySize,jQuery.validator.format(roliaMsg.v.max_by_size)),f()}))};validateSubmit_=t=>0;var g=async function(t){var n,o=!0;switch(t.attr("id")){case"scr-blog-penname":o=await w();break;case"scr-blog-series":"999999"==e.find("input:radio[name='sno']:checked").val()&&(n="#edit-blog-container input[name='seriesName']",o=i.element(n));break;case"scr-blog-title":n="#edit-blog-container textarea[name='title']",o=i.element(n);break;case"scr-blog-urllink":n="#edit-blog-container textarea[name='urllink']",o=i.element(n)}return o};_OP=t=>0;var m=async(n,o)=>{showWaiting("Preparing...");var i=!0;return await r(),await c(),await(async(t,n)=>{var o,i=new FormData;return i.append("f",t),i.append("p",n),o=await postDataAsForm("/api/blog/getPost",i).catch((t=>{throw t})),l.setPost(e,o),o})(n,o).catch((t=>{doneWaiting(),i=!1})),!!i&&(e.find("input:radio[name='sno'][value='0']").prop("checked",!0),$(".divNewSeriesName").hide(),doneWaiting(),b(),$("#modal-blog-editor").modal(),l.op="ADD",l.fno=n,d()?(t.apply("blog-title, blog-brief, blog-series, blog-contents, blog-urllink, blog-style"),t.goToScr("blog-title")):(t.apply("blog-intro, blog-penname, blog-congrat, blog-title, blog-brief, blog-series, blog-contents, blog-urllink, blog-style"),t.goToScr("blog-intro")),!1)},h=async n=>(await c(),await(async t=>{var n,o=new FormData;o.append("ano",t);const i=await postDataAsForm("/api/blog/getArticle",o).catch((t=>{throw t}));n=i.post,article=i.article,l.setPost(e,n),l.setArticle(e,article)})(n),b(),$("#modal-blog-editor").modal(),l.op="MODIFY",t.apply("blog-title, blog-brief, blog-series, blog-contents, blog-urllink, blog-style"),t.goToScr("blog-title"),!1),b=()=>{$(".adsbygoogle").css("z-index",1)},u=()=>{$(document).on("loadArticles",(()=>M())),$(document).on("loadHosts",(()=>S())),$(document).on("loadHostArticles",(()=>{_(memberId,seriesNo)})),$(document).on("loadBloggables",(function(t){A(fno),$("#modal-pick-forum").modal("hide")})),$(document).on("change",".pick-forum input:radio[name='fno']",(function(t){let e=$(this).val();A(e),$("#modal-pick-forum").modal("hide")})),$(document).on("click",".blog-sign-up",(function(e){(async()=>{!!Service.isSignedIn("sign-up-blog")&&(showWaiting("Checking..."),await r(),doneWaiting(),d()?popupMsg("You have already created your Rolia Blog.","warning"):(b(),$("#modal-blog-editor").modal(),t.apply("blog-intro, blog-penname, blog-registered"),t.goToScr("blog-intro")))})()})),$(document).on("click",".blog-add-just-posted",(function(t){const e=$(this).data("pno");m(fno,e)})),$(document).on("click",".blog-add",(function(t){const e=$(this).closest("li.post").data("pno");m(fno,e)})),$(document).on("click",".blog-modify",(function(t){const e=$(this).closest("dl.article").data("ano");h(e)})),$(document).on("click",".blog-rm",(function(t){(t=>{if(confirm("Are you sure you will remove this article from your blog? (The forum post won't be affected)")){var e=new FormData;e.append("ano",t),postDataAsForm("/api/blog/remove",e).then((e=>{$(`dl#a${t}`).fadeOut()}))}})($(this).closest("dl.article").data("ano"))}))},f=()=>{e.on("click",".submit",(function(t){t.preventDefault(),y()})),e.on("activated revisited","#scr-contents",(function(t){a.focus()})),e.on("activated",".step-scr.radio-input",(function(t){$(this).find("input:radio:checked").length>0?$(this).find("button.next").removeAttr("disabled"):$(this).find("button.next").attr("disabled","disabled")})),e.on("input change","textarea.sync",(function(t){let e=$(this).prop("name"),n=$(this).val().trim();l[e]=n})),e.on("input change","input.sync",(function(t){let e=$(this).prop("name"),n=$(this).val().trim();l[e]=n})),e.on("change","input:radio",(function(t){var e=$(this).closest("div.step-scr");let n=$(this).prop("name"),o=$(this).val(),a=$(this).data("brief");l[n]=o,e.find("button.next").removeAttr("disabled"),toastr.remove(),i.resetForm(),a&&a.length>0&&toastr.info(a)})),e.on("change","input:radio[name='sno']",(function(t){999999==$(this).val()?$(".divNewSeriesName").show():$(".divNewSeriesName").hide()}))};init_CKEditor=()=>{};var v=async function(){$taContents=e.find("textarea[name='contents']");var t=$taContents.val();$taContents.val(nl2br(t));var n="body {font-size: "+$("body").css("font-size")+"; font-family: "+$("body").css("font-family")+";} ";n+=" img{max-width:100%;height:auto;} ";var o=$taContents.get(0);a=CKEDITOR.replace(o,{contentsCss:n,tabIndex:3,customConfig:"/script/ckeditor_config.js?v=1"}),l.ckEditor=a;var i="#ckeMax";a.on("maximize",(function(){1==e.find(".cke_maximized").length?(Service.ckeMax=!0,window.history.pushState("ckeMax",null,i)):(Service.ckeMax=!1,location.hash==i&&(Service.historyBackOnly=!0,window.history.back()))}))},w=async()=>{if(!i.element("input[name='penName'"))return toastr.error("Please set a proper pen name."),!1;var t=new FormData;t.append("penName",l.penName),$("#modal-blog-editor").modal("hide"),showWaiting("Submitting...");var e=!1;return await postDataAsForm("/api/blog/signUp",t).catch((t=>{$("#modal-blog-editor").modal("show"),toastr.error(t.message),e=!0})),doneWaiting(),$("#modal-blog-editor").modal("show"),!e},y=()=>{if((()=>{let e="urllink",n=!0;return i.element("textarea[name='urllink'"),i.element("#urllink")||(e="urllink",toastr.error("The URL format is incorrect."),n=!1),0==l.title.length&&(e="title",toastr.error("Please enter the title"),n=!1),n||t.goToScr(e),n})()){var n,o;switch(k(),l.op){case"ADD":n="addArticle",o=N;break;case"MODIFY":n="modify",o=x}var s=new FormData;s.append("title",l.title),s.append("contents",l.contents),s.append("urllink",l.urllink),s.append("f",l.fno),s.append("p",l.pno),s.append("ano",l.ano),s.append("sno",l.sno),s.append("styleNo",l.styleNo),s.append("seriesName",l.seriesName),s.append("penName",l.penName),s.append("brief",l.brief),$("#modal-blog-editor").modal("hide"),showWaiting("Submitting..."),postDataAsForm(`/api/blog/${n}`,s).then((t=>{o(t),l.reset(),e.find("input[name='fno']").prop("checked",!1),e.find("textarea").val(""),a.setData(""),doneWaiting()}),(t=>{doneWaiting(),$("#modal-blog-editor").modal("show")}))}},k=()=>{a.setMode("wysiwyg",(()=>{})),s=e.find("iframe.cke_wysiwyg_frame").get(0).contentWindow.document.body;let t=$(s).clone(),n=!1;if(t.find("img,iframe").length>0&&(n=!0),n)t.find("img.user-image.pending").removeClass("pending").removeAttr("data-file-name"),t.find("div.user-image-holder.pending").removeClass("pending").removeAttr("data-file-name"),l.contents=t.html();else{t.find("p").each(((t,e)=>{let n=$(e).html().replace(/&nbsp;/gi," ").trim();0==n.length||"<br>"==n?$(e).remove():$(e).html(n)}));let e=t.get(0).textContent||t.get(0).innerText||"",n=t.find("a,blockquote,div,em,li,ol,pre,s,strong,sub,sup,u,ul,h1,h2,h3,h4,table").length>0,o=t.find("p").length>1;l.contents=n||o?t.html():e}};_CALLBACK=t=>0;var N=function(t){const e=t,n=e.pno;$(`li#p${n} .post-title`).html(e.title),popupMsg(roliaMsg.blog.article_added,"success")},x=function(t){const e=t,n=e.ano;$(`dl#a${n} .blog-series`).html(e.seriesName),$(`dl#a${n} .blog-title`).html(e.title),$(`dl#a${n} .blog-brief`).html(e.brief),popupMsg(roliaMsg.blog.article_modified,"success")},A=(t,e="bloggables")=>{window.fno=t;new Pagination(e,`/api/blog/getBloggableArr?fno=${t}`,20,"\n\t\t\t<li class=post data-pno={pno} >\n\t\t\t\t<a href=/f/post.php?f={fno}&p={pno} target=_blank>{title}</a> {date} \n\t\t\t\t<a class='btn btn-success btn-xs blog-add'>Add To Blog</a>\n\t\t\t</li> ")},S=(t="hosts")=>{const e=window.innerWidth>0?window.innerWidth:screen.width;var n=Math.ceil(e/20);new Pagination(t,"/api/blog/getHostArr",n," <div class='authorItem'>\n\t\t\t\t\t\t\t\t\t<a href=/blog/{userid} target=_blank> {penName}</a> ({articleCount})\n\t\t\t\t\t\t\t\t</div>")},D=t=>`\n\t\t\t<dl class=article data-ano={ano} id=a{ano} >\n\t\t\t\t<dt>\n\t\t\t\t\t<a href='/f/post.php?f={fno}&p={pno}' class='articleTitle' target=_blank >\n\t\t\t\t\t\t${t?"{penName}:":""}\n\t\t\t\t\t\t<span class=blog-series>{seriesName}</span>\n\t\t\t\t\t\t<span class=blog-title>{title}</span></a>\n\t\t\t\t</dt>\n\t\t\t\t<dd>\n\t\t\t\t\t<span class=blog-brief>{brief}</span>\n\t\t\t\t\t<span class="date">({dateUpdated})</span> \n\t\t\t\t\t${"undefined"!=typeof manageMode&&manageMode?"<a class='btn btn-default btn-xs blog-modify'>modify</a> <a class='btn btn-default btn-xs blog-rm'    >remove</a>":""}\n\t\t\t\t</dd>\n\t\t\t</dl>\n\t\t`,M=(t="articles")=>{const e=window.innerWidth>0?window.innerWidth:screen.width;var n=Math.ceil(e/120)+20;const o=D(!0);new Pagination(t,"/api/blog/getArticleArr",n,o)},_=(t,e,n="articles")=>{var o=`/api/blog/getHostArticleArr?m=${memberId}&s=${e}`;const i=D(!1);new Pagination(n,o,40,i)};this.init()},$(document).ready((function(){blogEditor=new BlogEditor}));